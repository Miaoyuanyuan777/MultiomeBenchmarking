library(Seurat)
library(ggplot2)
library(Matrix)
library(Signac)
library(stats4)
library(dplyr)
library(Matrix)
library(SeuratDisk)
save_path <- './Results/'
data_dir <-  './Dataset37/'
TRAIN_RNAfile = paste0(data_dir,"Dataset37_TRAIN_rna.h5")
TRAIN_RNA <- Read10X_h5(TRAIN_RNAfile)
TRAIN_ATACfile = paste0(data_dir,"Dataset37_TRAIN_atac.h5")
TRAIN_ATAC <- Read10X_h5(TRAIN_ATACfile)
TEST_RNAfile = paste0(data_dir,"Dataset37_TEST_rna.h5")
TEST_RNA <- Read10X_h5(TEST_RNAfile)
TEST_ATACfile = paste0(data_dir,"Dataset37_TEST_atac.h5")
TEST_ATAC <- Read10X_h5(TEST_ATACfile)
TRAIN_RNA_obj <- CreateSeuratObject(counts = TRAIN_RNA, assay="RNA",project = "RNA", min.cells = 0, min.features = 0)
TRAIN_RNA_obj <- NormalizeData(TRAIN_RNA_obj, normalization.method = "LogNormalize", scale.factor = 1e4) 
TRAIN_RNA_obj <- FindVariableFeatures(TRAIN_RNA_obj, selection.method = 'vst', nfeatures = 4000)
TEST_RNA_obj <- CreateSeuratObject(counts = TEST_RNA, assay="RNA",project = "RNA", min.cells = 0, min.features = 0)
TEST_RNA_obj <- NormalizeData(TEST_RNA_obj, normalization.method = "LogNormalize", scale.factor = 1e4) 
ATAC_chromassay <- CreateChromatinAssay(counts = TRAIN_ATAC,sep = c("-", "-"),min.cells = 0,min.features = 0)
TRAIN_ATAC_obj <- CreateSeuratObject(counts = ATAC_chromassay, assay="ATAC",project = "ATAC", min.cells = 0, min.features = 0)
ATAC_chromassay <- CreateChromatinAssay(counts = TEST_ATAC,sep = c("-", "-"),min.cells = 0,min.features = 0)
TEST_ATAC_obj <- CreateSeuratObject(counts = ATAC_chromassay, assay="ATAC",project = "ATAC", min.cells = 0, min.features = 0)
features<-TRAIN_RNA_obj@assays$RNA@var.features
DN = 30
options (warn = -1)
anchors <- FindTransferAnchors(reference =TRAIN_RNA_obj,query = TEST_RNA_obj,reduction = 'cca',features=features,reference.assay = 'RNA',query.assay = 'RNA', k.filter = NA, dims = 1:DN,verbose=FALSE)
refdata <- GetAssayData(object = TRAIN_ATAC_obj,assay = 'ATAC',slot = 'data',verbose=FALSE)
imputation <- TransferData(anchorset = anchors,refdata = refdata,weight.reduction = 'cca',dims = 1:DN,k.weight=10,verbose=FALSE)
Imp_New_genes = as.data.frame(imputation@data)
test_mod <- as.data.frame(TEST_ATAC_obj@assays$ATAC@counts)
shared<-intersect(rownames(test_mod),rownames(Imp_New_genes))
Imp_New_genes<-Imp_New_genes[shared,]
test_mod<-test_mod[shared,]
test_mod$index <- rownames(test_mod)
Imp_New_genes$index <- rownames(Imp_New_genes)
write_feather(test_mod, paste0(save_path,"Seurat_true.feather")) 
write_feather(Imp_New_genes, paste0(save_pathdatasets,"Seurat_pred.feather")) 